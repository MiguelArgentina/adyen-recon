<div data-controller="export-poll" data-export-poll-status-value="<%= @export.status %>" data-export-poll-export-id-value="<%= @export.id %>">
  <div class="page-header">
    <div>
      <h1 class="page-title">Export</h1>
      <p class="page-subtitle">
        <strong>Kind:</strong> <%= @export.kind.humanize %> ·
        <strong>Status:</strong> <%= status_badge(@export.status) %> ·
        <strong>Period:</strong> <%= @export.period_start %> – <%= @export.period_end %>
        <% if @row_count %> · <strong>Rows:</strong> <%= @row_count %><% end %>
      </p>
    </div>
    <div class="page-actions">
      <%= link_to "All exports", exports_path, class: "btn btn-ghost" %>
    </div>
  </div>

  <% if @export.generated? %>
    <div class="card space-y-4">
      <div class="flex items-center justify-between">
        <div class="font-medium">Export generated</div>
        <%= link_to "Download CSV", download_export_path(@export), class: "btn btn-primary" %>
      </div>
      <p class="text-sm text-[color:var(--text-muted)]">The CSV file is ready. Stored on the server path below.</p>
      <pre class="text-xs bg-[color:var(--surface-elevated)] border border-[color:var(--surface-border)] rounded-xl p-4 overflow-x-auto"><%= @export.file_path %></pre>
    </div>
  <% elsif @export.failed? %>
    <div class="card" data-tone="muted">
      <div class="font-medium mb-2 text-[color:var(--error-fg)]">Generation failed</div>
      <pre class="text-xs bg-white/80 border border-[color:var(--error-brd)] rounded-xl p-4 overflow-x-auto text-[color:var(--error-fg)]"><%= @export.error %></pre>
      <div class="mt-3">
        <%= link_to "Queue new export", new_export_path, class: "btn btn-secondary" %>
      </div>
    </div>
  <% else %>
    <div class="card">
      <div class="flex items-start justify-between">
        <div>
          <div class="font-medium mb-1">Export queued or processing…</div>
          <p class="text-sm text-[color:var(--text-muted)]">This page refreshes automatically. It will update once the CSV has been generated.</p>
        </div>
        <%= link_to "Refresh", export_path(@export), class: "btn btn-ghost" %>
      </div>
    </div>
  <% end %>

  <% if @export.generated? && (@row_count == 0) %>
    <div class="callout mt-4">
      <i class="fa fa-circle-info icon icon-primary"></i>
      <div>This export contains only a header (no data rows for the selected period).</div>
    </div>
  <% end %>

  <div class="mt-6 flex gap-3 flex-wrap">
    <%= link_to "All exports", exports_path, class: "btn btn-secondary" %>
    <%= link_to "New export", new_export_path, class: "btn btn-primary" %>
    <%= link_to "Uploads", report_files_path, class: "btn btn-ghost" %>
  </div>
</div>
