<!-- app/views/report_files/show.html.erb -->
<%= turbo_stream_from @file %>

<div class="page-header">
  <div>
    <h1 class="page-title">Report details</h1>
    <p class="page-subtitle">
      <strong>Kind:</strong> <span class="capitalize"><%= @file.kind %></span> ·
      <strong>Status:</strong>
      <turbo-frame id="<%= dom_id(@file, :status) %>">
        <%= render "report_files/status_badge", file: @file %>
      </turbo-frame>
      ·
      <strong>Reported on:</strong> <%= @file.reported_on %>
    </p>
  </div>
  <div class="page-actions">
    <%= link_to "Back to uploads", report_files_path, class: "btn btn-ghost" %>
  </div>
</div>

<div class="stat-grid">
  <div class="stat-card">
    <span class="label">Original filename</span>
    <span class="value font-mono text-sm break-all"><%= @file.original_filename || @file.file&.filename %></span>
  </div>
  <div class="stat-card">
    <span class="label">File size</span>
    <span class="value"><%= number_to_human_size(@file.bytes || @file.file&.byte_size) %></span>
  </div>
  <div class="stat-card">
    <span class="label">Rows created</span>
    <span class="value"><%= @stats[:rows_created] || (@file.statement? ? @file.statement_lines.count : @file.accounting_entries.count) %></span>
  </div>
  <div class="stat-card">
    <span class="label">Rows skipped</span>
    <span class="value"><%= @stats[:rows_skipped] || 0 %></span>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
  <div class="card">
    <div class="text-xs uppercase tracking-wide text-[color:var(--text-muted)] mb-1">Currencies</div>
    <% cur = Array(@stats[:currencies]) %>
    <% if cur.any? %>
      <div class="flex flex-wrap gap-2">
        <% cur.each do |c| %><span class="badge badge-muted"><%= c %></span><% end %>
      </div>
    <% else %>
      <div class="text-sm text-[color:var(--text-muted)]">n/a</div>
    <% end %>
  </div>
  <div class="card">
    <div class="text-xs uppercase tracking-wide text-[color:var(--text-muted)] mb-1">Elapsed (ms)</div>
    <div class="text-sm"><%= @stats[:elapsed_ms] || '—' %></div>
  </div>
  <div class="card">
    <div class="text-xs uppercase tracking-wide text-[color:var(--text-muted)] mb-1">Parse errors sample</div>
    <% errs = Array(@stats[:row_errors_sample]) %>
    <% if errs.any? %>
      <ul class="text-xs space-y-1 max-h-32 overflow-auto">
        <% errs.each do |e| %><li class="text-[11px] leading-tight"><%= e %></li><% end %>
      </ul>
    <% else %>
      <div class="text-sm text-[color:var(--text-muted)]">none</div>
    <% end %>
  </div>
</div>

<% if @sample_lines.any? %>
  <div class="card">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold tracking-wide">Sample lines (<%= @sample_lines.size %>)</h2>
      <span class="text-xs text-[color:var(--text-muted)]">Showing first 100 rows</span>
    </div>
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Book</th>
            <th>Category</th>
            <th>Type</th>
            <th>Status</th>
            <th>Amount</th>
            <th>Currency</th>
            <th>Reference</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
        <% @sample_lines.each do |ln| %>
          <tr>
            <td class="text-xs text-[color:var(--text-muted)]"><%= ln.line_no %></td>
            <td><%= ln.occurred_on %></td>
            <td><%= ln.book_date %></td>
            <td><%= ln.respond_to?(:category) ? ln.category : '' %></td>
            <td><%= ln.respond_to?(:type) ? ln.type : '' %></td>
            <td><%= ln.respond_to?(:status) ? ln.status : '' %></td>
            <td><%= minor_to_amount(ln.try(:amount_minor), ln.try(:currency)) %></td>
            <td><%= ln.try(:currency) %></td>
            <td class="truncate max-w-[10rem]" title="<%= ln.try(:reference) %>"><%= ln.try(:reference) %></td>
            <td class="truncate max-w-[14rem]" title="<%= ln.try(:description) %>"><%= ln.try(:description) %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <div class="callout mb-6"><i class="fa fa-info-circle icon icon-primary"></i><div>No rows parsed yet.</div></div>
<% end %>

<div class="flex items-center gap-3 mt-8">
  <%= link_to "Back to uploads", report_files_path, class: "btn btn-secondary" %>
  <%= link_to "Upload another", new_report_file_path, class: "btn btn-primary" %>
</div>
