<!-- app/views/report_files/new.html.erb -->
<div class="page-header">
  <div>
    <h1 class="page-title">Upload report</h1>
    <p class="page-subtitle">Drop a <strong>statement</strong> or <strong>accounting</strong> CSV and weâ€™ll auto-detect, parse, and feed it into your reconciliation queue.</p>
  </div>
  <div class="page-actions">
    <%= link_to "Back to uploads", report_files_path, class: "btn btn-ghost" %>
  </div>
</div>

<% if @file.errors.any? %>
  <div class="callout mb-6">
    <i class="fa fa-circle-exclamation icon icon-primary"></i>
    <div>
      <strong><%= pluralize(@file.errors.count, 'error') %> prevented the upload:</strong>
      <ul class="mt-2 list-disc list-inside text-sm">
        <% @file.errors.full_messages.each do |m| %>
          <li><%= m %></li>
        <% end %>
      </ul>
    </div>
  </div>
<% end %>

<%= form_with model: @file, url: report_files_path, multipart: true, class: "space-y-6" do |f| %>
  <div class="card">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
      <div>
        <label class="label">Reported on (optional)</label>
        <%= f.date_field :reported_on, class: "input mt-1", placeholder: Date.current.to_s %>
        <p class="text-[11px] text-[color:var(--text-muted)] mt-1">Defaults to today if left blank.</p>
      </div>
      <div>
        <label class="label">Currency (optional)</label>
        <%= f.text_field :currency, placeholder: "USD", class: "input mt-1" %>
      </div>
      <div class="md:col-span-2">
        <label class="label">CSV file</label>
        <%= f.file_field :file, class: "input mt-1" %>
      </div>

      <% if @file.kind.present? && @file.errors[:kind].blank? %>
        <div class="md:col-span-2 flex items-center gap-2 text-xs text-[color:var(--text-muted)]">
          <span class="badge badge-muted">Detected kind: <span class="ml-1 font-medium"><%= @file.kind %></span></span>
          <%= f.hidden_field :kind %>
        </div>
      <% else %>
        <div class="md:col-span-2">
          <label class="label">Report kind (manual override)</label>
          <%= f.select :kind, ReportFile.kinds.keys.map { |k| [k.humanize, k] }, { include_blank: "Auto (detect)" }, class: "select mt-1" %>
          <p class="text-[11px] text-[color:var(--text-muted)] mt-1">Normally auto-detected from headers. Choose one if detection failed.</p>
        </div>
      <% end %>
    </div>

    <div class="callout mt-6">
      <i class="fa fa-wand-magic-sparkles icon icon-primary"></i>
      <div>
        <b>Smart detection:</b> We inspect headers to classify the file automatically.
        If detection fails, pick a kind above and re-submit.
      </div>
    </div>
  </div>

  <div class="flex items-center justify-end gap-3">
    <%= link_to "Cancel", report_files_path, class: "btn btn-secondary" %>
    <%= f.submit "Upload & parse", class: "btn btn-primary" %>
  </div>
<% end %>
